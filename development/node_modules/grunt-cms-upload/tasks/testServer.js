'use strict';

var http = require('http');
module.exports = function(grunt) {
  grunt.registerTask('server', 'Starts a test server', function(){
    http.createServer(function(req, res) {
      grunt.verbose.writeln("Server Created");
      grunt.verbose.writeln("login url " + req.url);

      var data;
      if(req.method === "POST" && req.url === '/_/editor/template/assets/upload'){
        grunt.verbose.writeln("upload_received.");
        data = '';
        req.setEncoding('utf8');
        
        req.on('data', function(d){
          data += d;
        });
        
        req.on('end', function() {
          if(data.indexOf('form-data; name="datafile"') === -1){
            res.writeHead('404', {'Content-type': 'text/plain'});
            res.write('Bad Request\n');
            if(grunt.file.exists('tmp/default_options')){
              grunt.file.delete('tmp/default_options', {force: true});
            }
            if(grunt.file.exists('tmp/custom_options')){
              grunt.file.delete('tmp/custom_options', {force: true});
            }
            grunt.file.write('tmp/default_options', 'upload_missing');
            grunt.file.write('tmp/custom_options', 'upload_missing');
            res.end();
          } else {
            if(grunt.file.exists('tmp/default_options')){
              grunt.file.delete('tmp/default_options', {force: true});
            }
            if(grunt.file.exists('tmp/custom_options')){
              grunt.file.delete('tmp/custom_options', {force: true});
            }
            grunt.file.write('tmp/default_options', 'upload');
            grunt.file.write('tmp/custom_options', 'upload');
            res.writeHead(303, {'Location': '/_/editor/template/assets'});
            res.write('{}\n');
            res.end();
          }
        });
      } else {
        grunt.verbose.writeln("login received.");
        data = '';
        req.setEncoding('utf8');
        req.on('data', function(d){
          data += d;
        });
        req.on('end', function (){
          if(data.length === 0 || req.headers['content-type'] === null || req.headers['content-type'] === undefined || typeof req.headers['content-type'] === 'undefined' || req.headers['content-type'].indexOf('json') === -1) {
            res.writeHead('401', {'Content-type': 'text/plain'});
            grunt.verbose.writeln("login unauthorized.");
            res.write('Unauthorized');
          } else {
            res.writeHead('200', {'Content-Type': 'text/plain'});
            grunt.verbose.writeln("login authorized.");
            res.write('OK');
          }
          res.end();
        });
      }
    }).listen(9000, "artemis.local").on('close', function(){ grunt.verbose.writeln("Server closed.");});
  });
};
