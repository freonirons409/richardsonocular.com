'use strict';
var _ = require('underscore');

var http = require('http');
module.exports = function(grunt) {
  grunt.registerTask('server', 'Starts a test server', function(){
    return http.createServer(function(req, res) {
      grunt.verbose.writeln("Server Created");
      var data;
      if(req.method === "POST" && req.url === '/_/api/scaffold'){
        grunt.verbose.writeln("scaffold received.");
        data = '';
        req.setEncoding('utf8');
        
        req.on('data', function(d){
          grunt.verbose.writeln("data received.");
          data += d;
        });
        req.on('end', function() {
          grunt.verbose.writeln("request headers " + JSON.stringify(req.headers));
          if(data.indexOf('institution') === -1 || req.headers['content-type'].toLowerCase().indexOf('json') === -1){
            grunt.verbose.writeln('scaffold upload failed.');
            res.writeHead('404', {'Content-type': 'text/plain'});
            res.write('Bad Request\n');
            if(grunt.file.exists('tmp/default_options')) {
              grunt.file.delete('tmp/default_options', {force: true});
            }
            if(grunt.file.exists('tmp/custom_options')) {
              grunt.file.delete('tmp/custom_options', {force: true});
            }
            grunt.file.write('tmp/default_options', 'upload_missing');
            grunt.file.write('tmp/custom_options', 'upload_missing');
            res.end();
          } else {
            grunt.verbose.writeln('scaffold upload succeed.');
            if(grunt.file.exists('tmp/default_options')) {
              grunt.file.delete('tmp/default_options', {force: true});
            }
            if(grunt.file.exists('tmp/custom_options')) {
              grunt.file.delete('tmp/custom_options', {force: true});
            }
            grunt.file.write('tmp/default_options', 'upload');
            grunt.file.write('tmp/custom_options', 'upload');
            res.writeHead(200, {'Content-Type': 'application/json'});
            res.write('{}\n');
            res.end();
          }
        });
      } else {
        data = '';
        req.setEncoding('utf8');
        req.on('data', function(d){
          data += d;
        });
        req.on('end', function (){
          if(data.length === 0) {
            grunt.verbose.writeln('url: ' + req.url);
            grunt.verbose.writeln("Login failed.");
            res.writeHead('401', {'Content-Type': 'text/plain'});
            res.write('Unauthorized');
          } else {
            grunt.verbose.writeln('url: ' + req.url);
            grunt.verbose.writeln('Login received.');
            res.writeHead('200', {'Content-Type': 'text/plain'});
            res.write('OK');
            res.end();
          }
        });
      }
    }).listen(9000, "artemis.local").on('close', function(){ grunt.verbose.writeln("Server closed.");});
  });
};
